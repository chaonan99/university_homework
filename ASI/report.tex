\input{header}

\begin{document}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%封面与目录%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \begin{titlepage}
% \begin{center}
% % Upper part of the page
% \includegraphics[width=0.25\textwidth]{resource/logo.jpg}\\[1cm]
% \textsc{\LARGE Department of Automation}\\[1.5cm]
% \fs{\Large 检测原理系列实验}\\[0.5cm]
% % Title
% \hrulefill
% \\[0.8cm]{\centering \huge \hei {\ttfamily AS-i}技术实验报告}\\[0.4cm]
% \hrulefill
% \\[4cm]

% % Author and supervisor
% \begin{tabbing}       %tabbing  列表

%  \hspace*{5cm} \= \hspace{2.6cm} \= \kill
%  % \=     in tabbing environment, sets a tab stop
%  % \kill  in a\tabbing environment, deletes previous line so tabs can be set without outputting text.
%  % \>     in tabbing environment is a forward tab.

% \>{\fs\sihao\textbf {班\hspace{1cm}级 \ \ ：}}\>  {\centering\fs\sihao\textbf{~~~~~~~~~~~自~~3~2}} \\
% \\
% \>{\fs\sihao\textbf {姓\hspace{1cm}名 \ \ ：}}\>  {\centering\fs\sihao\textbf{~陈~昊~楠~(2013011449)}}\\
% \\
% \>{\fs\sihao\textbf {同\hspace{0.2cm}组\hspace{0.3cm}人 \ \ ：}}\>  {\centering\fs\sihao\textbf{~陈~炜~祥~(2013011456)}}\\
% \\
% \>{\fs\sihao\textbf {指导教师 \ \ ：}}\>  {\centering\fs\sihao\textbf{~~~~~~~~~~~陆~~~~~耿}} \\

% \end{tabbing}
% \vfill
% {\large \today}
% \end{center}
% \end{titlepage}

\tableofcontents
\clearpage

%%%%%%%%%%%%%%%%%%%%%%%%%%正文部分%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\part{AS-i总线技术(V3.0)特性研究}
\section{AS-i总线原理与特点}
\subsection{AS-i总线概述}
AS-i是“执行器-传感器-接口”的英文缩写（Actuator Sensor- interface）。它是一种用来在控制器（主站）和传感器/执行器（从站）之间双向交换信息、主从结构的总线网络，它属于现场总线下面底层的监控网络系统。\\
AS-i主站是AS-i总线系统的核心，它由AS-i主机和控制器（如PC和PLC等）组成。向上通过主站中的网关可以和多种现场总线（如PROFIBUS，FF，CANBUS等）进行连接，向下可以挂接一批AS-i从站，主站将按照AS-i通信协议与各个从站之间进行数据交换。\\
AS-i从站一般可分为两种类型，一种是智能型开关装置，它本身就带有从机专用芯片和配套电路，形成一体化从站，这种智能型传感器/执行器可以直接和AS-i总线连接。第二种是专门设计的AS-i 连接模块，在这种模块中带有从机专用芯片和配套电路，它除了具有通信接口外还带有I/O接口，这些I/O接口可以和普通的传感器/执行器相连接构成分离型从站。\\
AS-i系统主站和从站之间的通信采用非屏蔽、非绞接的两芯电缆。其中一种是普通的圆柱形电缆，另一种是专用的扁平电缆，由于扁平电缆采用一种特殊的穿刺安装方式把线压在连接件上，所以安装拆卸即简单又可靠。在两芯电缆上除传输信号外还通过网络向主站和从站提供电源。
\subsection{AS-i技术规范V3.0特点}
2006年AS-i国际协会发布了最新的AS-i技术规范V3.0，它比原有的V2.1版本有了更大的改进，并完全兼容以前版本的技术内容，最大的改进有以下两点：
\begin{enumerate}
\item 增加了AS-i安全系统元件的规范。
\item 增加了新的AS-i主站和从站规范以及组合处理类型（CTT,Combined Transaction Type）的定义。
\end{enumerate}
在自动化生产现场，不同的客户有不同的需求，特别是对于从站的性能、连接、安装都有不同的要求。在新的V3.0规范中，增加了很多新的从站规范，这也使生产商可以给客户提供更加多样化的产品。随着自动化产品在监控系统中的广泛应用，安全概念的不断变革和安全技术的不断更新，作为现场最底层的AS-i总线系统也在新的V3.0规范中增加了相关安全系统产品的规范。组合处理类型（CTT）的定义为AS-i系统的通讯增加了新的功能，包括对模拟量模块和安全输入/输出模块的通讯支持。
\section{实验内容与分析}
\subsection{编址}
按照实验指导书进行操作，找到了各个网关对应传感器的位置，并学习了使用手持编程器编址和网关编址的方法。最终确定的编址如表\ref{tab:aa}。

\begin{table}[htbp]
\centering
\begin{tabular}{|c|c|c|}
	\hline
	从站类型 & 从站名称 & 地址 \\
	\hline
	开关量 & 控制箱型 4 入/4 出模块 & 2A \\
	开关量 & 现场型 4 入/4 出模块 & 4A \\
	开关量 & 现场紧凑型 2 输入模块 & 5A \\
	模拟量 & 现场型 2 输入模块 & 3 \\
	模拟量 & 控制箱型 2 输出模块 & 1 \\
	\hline
\end{tabular}
\caption{AS-i从站地址}
\label{tab:aa}
\end{table}

\subsection{错误诊断}
实验现象如下：
\paragraph{一个AS-i从站丢失}
\begin{enumerate}
\item 拔出现场型4入/4出模块，网关LCD显示器显示 {\ttfamily Missing 4A}，Config err红灯亮；将现场型4入/4出模块重新接入系统，网关红灯灭，系统恢复正常。这是因为该模块地址没有变，只是拔下模块，系统在轮询到该地址时将不会得到输入信号，因此显示丢失。重新接入后又能询问到信号，因此恢复正常。
\item 将现场型2输入模拟量模块的紧固螺钉拧松，使网关LCD显示器显示 {\ttfamily Missing 3}，Config err红灯亮。将其重新编址为6，再次接入没有恢复正常（此时总线系统处于运行模式），进退一次配置模式，则恢复正常且模块被编址为6。
\item 将现场型2输入模拟量模块的紧固螺钉拧松，使网关LCD显示器显示 {\ttfamily Missing 3}，Config err红灯亮。将其重新编址为0，再次接入则恢复正常，模块地址仍为6。
\end{enumerate}
\paragraph{一个AS-i从站未配置}
\begin{enumerate}
\item 将现场型4入/4出模块的电源插头（黑色）拧下，即卸掉1个从站。将网关置于配置模式，网关LCD显示器将循环显示系统中的4个从站地址。然后保存当前配置并将网关置于运行模式，AS-i系统运行正常。
\item 将现场型4入/4出模块重新接入系统，Config err红灯亮，模块的 {\ttfamily Fault}红灯亮，网关LCD显示器显示 {\ttfamily Unknown 4A}。重新进退一次配置模式，则系统又恢复正常。因为配置模式中可以重新设定所有的地址，之前地址没有冲突，因此是可以重新设定的。
\end{enumerate}
\paragraph{两个AS-i从站地址相同}
\begin{enumerate}
\item 将网关置于配置模式，用手持编程器为控制箱型2输出模拟量模块和现场型2输入模拟量模块的地址配置为相同地址，保存当前配置并将网关置于运行模式，网关的 Config err 红灯亮，显示 {\ttfamily Missing 1} 和 {\ttfamily Duplicate 3}。
\item 重新置网关于配置模式，用手持编程器为控制箱型2输出模拟量模块和现场型2输入模拟量模块的地址重新配置为不同的地址，网关LCD显示器将循环显示系统中的5个从站地址，保存当前配置并将网关置于运行模式，AS-i系统恢复正常。
\end{enumerate}

\subsection{数据表示方法}
AS-i从站的I/O模块都可以下接一些传感器。本实验分别对5个AS-i从站（即5种不同的I/O模块），以及它们各自接入的传感器或执行器的种类和占用的数据位进行考察。确认数据位可以通过每个I/O模块面板指示灯，或通过网关高级显示模式。在AS-i控制工具软件中也可以看到这种变化，参见下一节的实验。\\
实验现象见表\ref{tab:dr}。其中超声波接在了控制箱型 2 输出模块的1通道。
\begin{table}[htbp]
\centering
\begin{tabular}{|c|c|c|c|}
	\hline
	传感器 & 所接从站地址 & 通过I/O模块 & 通过显示模式 \\
	\hline
	电容式 & 2A & 4号黄灯亮 & 0000变为1000 \\
	反射板型光电 & 4A & IN1灭 & 0001变为0000 \\
	电磁式 & 5A & I2亮 & 0001变为0011 \\
	色标对比 & 5A & I1灭 & 0001变为0000 \\
	倾角 & 1 & & 滚动条跟踪变化，0和1都变\\
	超声波 & 1 & & 滚动条跟踪变化，只有1变 \\
	\hline
\end{tabular}
\caption{AS-i系统数据表示方法实验现象}
\label{tab:dr}
\end{table}

\subsection{AS-i控制工具软件使用}
按照实验指导书进行软件的配置。
\paragraph{编址}
若在线修改从站系统的地址，观察到软件界面右下角出现 {\ttfamily Configuration error}，面板红灯亮。
\paragraph{数据表示方法}
点击控制箱型 4 入/4 出模块（对应电容传感器）地址位，在 {\ttfamily Slave Configurtion Address} 的 {\ttfamily Data and parameter} 菜单项中观察，激活电容传感器，对应Input 3 打勾。用鼠标分别点中这个模块输出Outputs\quad 0,1,2,3，模块面板上OUT\quad 1,2,3,4的黄灯亮。

\subsection{AS-i输出模块的看门狗功能}
\paragraph{看门狗功能开启}
中断通信，模块的FAULT指示灯全亮，且输出黄灯灭，网关LED灯灭。重新将通信置于正常，FAULT指示灯灭，输出黄灯和网关LED又按原来的方式亮。
\paragraph{看门狗功能取消}
中断通信，模块的FAULT指示灯全亮，但输出黄灯不灭，网关LED灯也不灭灭。重新将通信置于正常，FAULT指示灯灭。

\subsection{色标、超声波和倾角传感器的调节方法}
\paragraph{色标传感器} 按指导书调节即可。
\paragraph{超声波传感器} 按指导书设定传感器的A1，A2工作点，在网关LCD显示屏进入 {\ttfamily Analog Input} 跟踪传感器输出，记录目标板与传感器间距和输入通道示数的关系如表\ref{tab:dc}。关系曲线如图\ref{fig:dcr}。

\begin{table}[htbp]
\centering
\begin{tabular}{|c|ccccc|}
	\hline
	目标板与传感器间距(cm) & 5 & 10 & 15 & 20 & 25 \\
	\hline
	输入通道示数 & 3994 & 7643 & 12302 & 16523 & 19977 \\
	\hline
\end{tabular}
\caption{超声传感器距离与输出关系}
\label{tab:dc}
\end{table}

\begin{figure}[htbp]
\centering
\includegraphics[width=11cm]{resource/dcr.png}
\caption{超声传感器距离示数曲线}
\label{fig:dcr}
\end{figure}

\paragraph{倾角传感器} 按指导书设定传感器的x，y轴输出模式，在网关LCD显示屏进入 {\ttfamily Analog Input} 跟踪传感器输出，记录目标板与传感器x，y方向倾角和输入通道示数的关系如表\ref{tab:dq}。关系曲线如图\ref{fig:dqr}。

\begin{table}[htbp]
\centering
\begin{tabular}{|c|c|ccccccc|}
	\hline
	\multirow{2}*{x方向} & 倾角 & $0^{\circ}$ & $15^{\circ}$ & $30^{\circ}$ &
		$45^{\circ}$ & $60^{\circ}$ & $75^{\circ}$ & $90^{\circ}$ \\
	\cline{2-9}
	& 输入通道示数 & 4139 & 4670 & 6146 & 7026 & 8253 & 9371 & 11431 \\
	\hline
	\multirow{2}*{y方向} & 倾角 & $0^{\circ}$ & $15^{\circ}$ & $30^{\circ}$ &
		$45^{\circ}$ & $60^{\circ}$ & $75^{\circ}$ & $90^{\circ}$ \\
	\cline{2-9}
	& 输入通道示数 & 4234 & 4767 & 5318 & 5982 & 6731 & 7106 & 8381 \\
	\hline
\end{tabular}
\caption{倾角传感器x，y方向倾角与输出关系}
\label{tab:dq}
\end{table}

\begin{figure}[htbp]
\centering
\includegraphics[width=11cm]{resource/dqr.png}
\caption{倾角传感器距离示数曲线}
\label{fig:dqr}
\end{figure}

\section{思考题}
\begin{enumerate}
\item 利用网关给从站编址，网关处于配置模式和运行模式方法一样吗？为什么？\\
不一样。处于配置模式时，对地址进行的修改在退出配置模式即可保存；处于运行模式时，对地址进行修改会亮红灯报错，只有先进入、再退出配置模式才能消除错误，保存更改。
\item 0地址的作用？自动赋值功能需满足那些条件？\\
从错误诊断部分的实验结果来看，0地址表示自动分配地址。自动赋值功能需要拔下之前地址分配没有错误，且地址没有在配置模式中重新设定过，网关才能确定需要自动为其分配的地址值。
\item 输出模块“看门狗”功能的作用是什么？\\
看门狗为整个系统的中保护机制，当通信断开时候，会限制输出为低电平， 从而保护电路输出及工作人员的安全。
\end{enumerate}


\part{实现{\ttfamily PLC}控制器对其外围I/O设备的控制}
\section{实验原理}
\subsection{{\ttfamily PLC}控制器功能}
{\ttfamily PLC}（可编程控制器）可以通过接口与AS-i网关硬件和计算机连接，通过软件的编程实现对硬件的控制，且可以支持多点通信，同时控制多个AS-i主站，组成复杂网络。\\
本实验系统中使用的{\ttfamily PLC}选用西门子公司的 {\ttfamily S7-300}系列的 {\ttfamily CPU 315-2DP}，它是一种小型模块化可编程控制器，有两个通信接口，分别为 {\ttfamily PRFIBUS-DP}接口和MPI接口。使用专用转换器和紫色屏蔽电缆直接将{\ttfamily PLC}的{\ttfamily PRFIBUS-DP}接口与{\ttfamily AS-i}网关的{\ttfamily RS-485}接口连接，完成{\ttfamily PRFIBUS-DP}网络层的硬件连接。使用编程适配器{\ttfamily MPI Link-BUS}直接将{\ttfamily PLC}的{\ttfamily MPI}接口与PC机的{\ttfamily BUS}接口连接，完成{\ttfamily MPI}多点通信层的硬件连接。

\subsection{编程方法} 实验中使用 {\ttfamily AS-interface Control Tools}软件,完成 {\ttfamily AS-i}系统的配置和网络组态。使用STEP7标准软件包中的SIMATIC管理器、符号编辑器、编程语言、硬件配置和网络组态等软件实现对SIMATIC可编程控制器的编程。具体方法按实验指导书操作即可。

\section{实验内容}
\subsection{模块地址与端口}
\paragraph{从站地址} 将网关与计算机连接，用上一个实验中的AS-i控制工具软件查看6个从站的地址。地址记录如表\ref{tab:address}。

\begin{table}[htbp]
\centering
\begin{tabular}{|c|c|c|}
	\hline
	从站类型 & 从站名称 & 地址 \\
	\hline
	开关量 & G2扁平模块 （4入3出） & 7A \\
	开关量 & KE控制箱型模块 (4入3出) & 8A \\
	开关量 & 智能型光电传感器 & 5 \\
	开关量 & 智能型电感式传感器 & 6 \\
	模拟量 & 模拟量输入模块 （2入） & 27 \\
	模拟量 & 模拟量输出模块 （2出） & 26 \\
	\hline
\end{tabular}
\caption{AS-i从站地址（实验二）}
\label{tab:address}
\end{table}

\paragraph{数字量传感器端口} 进一步{\ttfamily Data and Parameter} 界面，查看各传感器占用的端口如表\ref{tab:port}。

\begin{table}[htbp]
\centering
\begin{tabular}{|c|c|c|c|}
	\hline
	传感器及输出 & 所接从站地址 & I/O口 \\
	\hline
	漫反射型光电 & 7A & IN3 \\
	电感式 & 7A & IN1 \\
	电磁式 & 7A & OUT1 \\
	红色LED & 8A & OUT0 \\
	黄色LED & 8A & OUT1 \\
	蓝色LED & 8A & OUT2 \\
	\hline
\end{tabular}
\caption{AS-i系统数据表示方法实验现象（部分）}
\label{tab:port}
\end{table}

\paragraph{模拟量传感器} 监测重力传感器加砝码时的输出情况。如表\ref{tab:weight}。曲线如图\ref{fig:weight}。通过滑动{\ttfamily ch0} 通道的标尺改变输出电流，连接在模块输出端口的小电流表跟踪情况良好。

\begin{minipage}{\textwidth}
\begin{minipage}[b]{0.35\textwidth}
\centering
\pgfplotstabletypeset[
	every head row/.style={before row=\hline, after row=\hline},
	every last row/.style={after row=\hline},
	every first column/.style={column type/.add={|}{|}},
	every last column/.style={column type/.add={}{|}},
	columns/gforce/.style={column name=所加砝码质量(g)},
	columns/analog/.style={column name=输入通道示数},
]{resource/weight.txt}
\captionof{table}{重力传感器砝码质量与输出模拟量关系}
\label{tab:weight}
\end{minipage}
\hfill
\begin{minipage}[b]{0.62\textwidth}
\centering
\begin{tikzpicture}
\begin{axis}[
    xlabel={砝码质量(g)},
    ylabel={模拟量输出},
    % legend pos=south east,
    % legend entries={Concrete,Linoleum},
    ]
  \addplot table [x=gforce,y=analog] {resource/weight.txt};
\end{axis}
\end{tikzpicture}
\captionof{figure}{重力传感器输出特性曲线}
\label{fig:weight}
\end{minipage}
\end{minipage}

\subsection{实验系统的硬件站点配置和网络组态}
按照指导书上的硬件站点配置教程进行实验。站点配置如图\ref{fig:hard_conf}，网络组态如图\ref{fig:net_org}。
在图\ref{fig:hard_conf}中，

\begin{figure}[htbp]
\centering
\includegraphics[width=12cm]{resource/hard_config.png}
\caption{站点配置图}
\caption*{\small{\ttfamily PS 307 2A} 表示插入的电源模块，{\ttfamily DP} 表示主站系统，{\ttfamily CPU315-2DP} 下挂接从站系统。下方表格显示了网关的外围设备及其地址，分别为{\ttfamily 32 Byte Digital In/Out (0-31B)}（数字量输入/输出），{\ttfamily 56 Byte Analog Input (25-31)}（模拟量输入） 和 {\ttfamily 56 Byte Analog Output (25-31)}（模拟量输出）。}
\label{fig:hard_conf}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[width=12cm]{resource/net_organize.png}
\caption{网络组态图}
\caption*{\small 图中显示了{\ttfamily DP}的地址为2，{\ttfamily CPU315-2DP} 地址为3。{\ttfamily VBG-PB-KF -R4} 图标已连接在网络上，说明在网络中添加网关成功。}
\label{fig:net_org}
\end{figure}

\subsection{PLC编程和在线监控}
\paragraph{符号表定义}
按照指导书提供的 AS-i 地址与 I/Q 地址和 PIW/POW 地址对应关系，设置符号表如图\ref{fig:sign_form}。

\begin{figure}[htbp]
\centering
\includegraphics[width=12cm]{resource/sign_form.png}
\caption{符号表定义}
\label{fig:sign_form}
\end{figure}

\paragraph{简单编程}
按照图\ref{fig:easy}所示的模式测试各种数字量输入、输出模块，均能正确运行。

\begin{figure}[htbp]
\centering
\includegraphics[width=12cm]{resource/program_easy.png}
\caption{简单控制程序}
\label{fig:easy}
\end{figure}

\paragraph{复杂网络组态}
按照指导书在 {\ttfamily DP} 主站系统中挂接两个 {\ttfamily AS-i} 网关，硬件配置与网络组态的结果分别为图\ref{fig:hard_conf_2} 和图\ref{fig:net_org_2}。符号表的完整定义如图\ref{fig:sign_form_2}。

\begin{figure}[htbp]
\begin{minipage}{0.5\textwidth}
\centering
\includegraphics[width=7cm]{resource/hard_config_2.png}
\caption{复杂网络站点配置图}
\label{fig:hard_conf_2}
\end{minipage}
\hfill
\begin{minipage}{0.5\textwidth}
\centering
\includegraphics[width=7cm]{resource/net_organize_2.png}
\caption{复杂网络组态图}
\label{fig:net_org_2}
\end{minipage}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[width=12cm]{resource/sign_form_2.png}
\caption{符号表完整定义}
\label{fig:sign_form_2}
\end{figure}

\subsection{PLC程序设计}
\subsubsection{跑马灯实验}
\paragraph{实验要求及预期} 要求能够实现电感式传器给出启动信号后，3个不同颜色的 LED 灯能依次循环点亮，每个圈的时间为2秒钟。当智能型电感式传器给出停止信号后，3个LED 彩灯无论 处于何种状态，均能立刻熄灭。

\paragraph{设计思路}
\begin{enumerate}
\item {\ttfamily S\_PULSE}脉冲定时器输入端S有一个上升沿启动计时，定时器是在 S输入端信号状态为“1”时运行，运行时间由输入端 TV指定。只要定时器运行，输出端 Q的信号状态就为“1”。如果在时间间隔结束前，S输入端从“1”变为“0”，则定时器将停止。这种情况下，输出端 Q的信号状态为“0”。如果在定时器运行期间定时器复位 R输入从“0”变为“1”时，则定时器将被复位。当前时间和时间基准也被设置为零。
\item 设计停止功能，只需将智能型电感式传器信号接在{\ttfamily S\_PULSE}脉冲定时器 R输入端。
\item 设计循环计数功能，需要将每一级计时器的Q输出取反接到下一级的S输入，并将最后一级计时器Q输出取反接回第一级的S输入。
\item 设计启动信号。由于定时器必须在S输入保持为1时才能运行，因此需要锁存启动信号，将电感式传器信号接到SR锁存器S输入端。这样，只要启动信号给出，SR锁存器的Q输出端就可以保持为“1”。这种设置也防止了启动信号重复输入会重复触发计时器的情况。
\item 启动信号与循环信号相与（串联）。当装置未启动时，循环信号保持为“1”，而锁存器输出为“0”。启动信号给出，锁存器输出上升沿启动计时。当计数到最后一级时，最后一级输出端 Q先变为“1”，计时结束后产生下降沿，取反回到第一级提供上升沿，则启动下一轮计数。
\end{enumerate}

\paragraph{程序框图} 如图\ref{fig:horse}。

\begin{figure}[htbp]
\centering
\includegraphics[width=16cm]{resource/program_horse.png}
\caption{跑马灯程序框图}
\label{fig:horse}
\end{figure}

\subsubsection{应变式传感器称重显示实验}
\paragraph{实验要求及预期} 要求能够实现在应变式传感器上放置小砝码并一一增加，当砝码个数超过5个时LED红灯点亮报警（1个砝码重99-100），可在电流表上以分度显示砝码个数或以分度显示砝码重量。
\paragraph{设计思路}
\begin{enumerate}
\item 重力传感器在没有重物时输出不一定为0，需要零点调节。可以将传感器接在一个减法器输入端，减法器另一端可调，以实现调零点。
\item 模拟量输出可以使用除法器，除以单位砝码质量，即可得到砝码个数。通过比较器将个数与6比较，则可以判断是否超出。
\item 为了调节电流表的输入量，只需在除法器后再连接乘法器，调节扩大的系数，即可使砝码个数和分度对应起来。
\end{enumerate}
\paragraph{程序框图} 如图\ref{fig:calculate}

\begin{figure}[htbp]
\centering
\includegraphics[width=13cm]{resource/program_calculate.png}
\caption{称重程序框图}
\label{fig:calculate}
\end{figure}


\end{document}
